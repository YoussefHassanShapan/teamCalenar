const cds = require('@sap/cds');

module.exports = async function (srv) {
  const { Employee, Vacation } = cds.entities('jal');

  srv.on('getEmployeesOn', async (req) => {
    const targetDate = req.data.date;
    
    const result = await SELECT
      .from(Vacation)
      .columns('employee_ID')
      .where`startDate <= ${targetDate} and endDate >= ${targetDate}`;

    const ids = result.map(r => r.employee_ID);

    const employees = await SELECT
      .from(Employee)
      .where({ ID: { in: ids } });

    return employees.map(e => ({
      employeeID: e.ID,
      name: e.name,
      email: e.email,
    }));
  });
};